<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Resolver Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 20px; }
        h1 { text-align: center; color: #0056b3; }
        .container { display: flex; flex-wrap: wrap; justify-content: space-around; }
        .metric-card { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 20px; margin: 10px; min-width: 200px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-card h2 { margin-top: 0; font-size: 1.2em; color: #0056b3; }
        .metric-card .value { font-size: 2em; font-weight: bold; color: #333; }
        .table-card { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 20px; margin: 10px; width: 45%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table-card h2 { margin-top: 0; font-size: 1.2em; color: #0056b3; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>DNS Resolver Dashboard</h1>
    <div class="container">
        <div class="metric-card">
            <h2>QPS</h2>
            <div id="qps" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Total Queries</h2>
            <div id="total-queries" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>CPU Usage</h2>
            <div id="cpu-usage" class="value">0%</div>
        </div>
        <div class="metric-card">
            <h2>Memory Usage</h2>
            <div id="memory-usage" class="value">0%</div>
        </div>
        <div class="metric-card">
            <h2>Goroutines</h2>
            <div id="goroutines" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Cache Hits</h2>
            <div id="cache-hits" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Cache Misses</h2>
            <div id="cache-misses" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Cache Hit Rate</h2>
            <div id="cache-hit-rate" class="value">0%</div>
        </div>
    </div>
    <div class="container">
        <div class="table-card">
            <h2>Top NXDOMAINs</h2>
            <table id="top-nx-domains">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="table-card">
            <h2>Top Latency Domains (ms)</h2>
            <table id="top-latency-domains">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Avg Latency</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container">
        <div class="table-card" style="width: 90%;">
            <h2>Server Configuration</h2>
            <form id="server-config-form">
                <label for="server-role">Server Role:</label>
                <select id="server-role" name="server-role">
                    <option value="standalone">Standalone</option>
                    <option value="master">Master</option>
                    <option value="slave">Slave</option>
                </select>
                <div id="master-config" style="display: none;">
                    <h3>Master Configuration</h3>
                    <label for="slave-ips">Slave IPs:</label>
                    <input type="text" id="slave-ips" name="slave-ips" placeholder="e.g., 192.168.1.10, 192.168.1.11">
                </div>
                <div id="slave-config" style="display: none;">
                    <h3>Slave Configuration</h3>
                    <label for="master-ip">Master IP:</label>
                    <input type="text" id="master-ip" name="master-ip" placeholder="e.g., 192.168.1.1">
                </div>
                <button type="submit">Save Configuration</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="table-card">
            <h2>Query Types</h2>
            <table id="query-types">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="table-card">
            <h2>Response Codes</h2>
            <table id="response-codes">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container">
        <div class="metric-card">
            <h2>Server Role</h2>
            <div id="server-role-status" class="value">Unknown</div>
        </div>
    </div>
    <div class="container">
        <div class="table-card" style="width: 90%;">
            <h2>Zone Management</h2>
            <button onclick="showAddZoneModal()">Add Zone</button>
            <input type="file" id="zone-file-input" style="display: none;" onchange="importZoneFile()">
            <button onclick="document.getElementById('zone-file-input').click()">Import BIND9 Zone File</button>
            <table id="zones-table">
                <thead>
                    <tr>
                        <th>Zone Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function fetchMetrics() {
            fetch('/metrics.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('qps').textContent = data.qps.toFixed(2);
                    document.getElementById('total-queries').textContent = data.total_queries;
                    document.getElementById('cpu-usage').textContent = data.cpu_usage.toFixed(2) + '%';
                    document.getElementById('memory-usage').textContent = data.memory_usage.toFixed(2) + '%';
                    document.getElementById('goroutines').textContent = data.goroutines;
                    document.getElementById('cache-hits').textContent = data.cache_hits;
                    document.getElementById('cache-misses').textContent = data.cache_misses;
                    document.getElementById('cache-hit-rate').textContent = data.cache_hit_rate.toFixed(2) + '%';

                    updateTable('top-nx-domains', data.top_nx_domains, ['domain', 'count']);
                    updateTable('top-latency-domains', data.top_latency_domains, ['domain', 'avg_latency']);
                    updateTable('query-types', data.query_types, ['type', 'count']);
                    updateTable('response-codes', data.response_codes, ['code', 'count']);
                })
                .catch(error => console.error('Error fetching metrics:', error));
        }

        function updateTable(tableId, data, columns) {
            const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear existing rows
            if (data) {
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    columns.forEach((col, index) => {
                        const cell = row.insertCell(index);
                        let value = item[col];
                        if (typeof value === 'number' && col === 'avg_latency') {
                            value = value.toFixed(4);
                        }
                        cell.textContent = value;
                    });
                });
            }
        }

        // Fetch metrics on page load and then every 2 seconds
        fetchMetrics();
        setInterval(fetchMetrics, 2000);

        function fetchZones() {
            fetch('/zones')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('zones-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = ''; // Clear existing rows
                    if (data) {
                        data.forEach(zone => {
                            const row = tableBody.insertRow();
                            const nameCell = row.insertCell(0);
                            const actionsCell = row.insertCell(1);
                            nameCell.textContent = zone.name;
                            actionsCell.innerHTML = `
                                <button onclick="showEditZoneModal('${zone.name}')">Edit</button>
                                <button onclick="deleteZone('${zone.name}')">Delete</button>
                                <button onclick="exportZone('${zone.name}')">Export</button>
                            `;
                        });
                    }
                })
                .catch(error => console.error('Error fetching zones:', error));
        }

        function showAddZoneModal() {
            // ...
        }

        function showEditZoneModal(zoneName) {
            // ...
        }

        function deleteZone(zoneName) {
            // ...
        }

        function exportZone(zoneName) {
            // ...
        }

        function importZoneFile() {
            const fileInput = document.getElementById('zone-file-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a zone file to import.');
                return;
            }

            const formData = new FormData();
            formData.append('zonefile', file);

            fetch('/zones/import', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (response.ok) {
                    alert('Zone file imported successfully!');
                    fetchZones(); // Refresh the zones list
                } else {
                    alert('Failed to import zone file.');
                }
            })
            .catch(error => {
                console.error('Error importing zone file:', error);
                alert('An error occurred while importing the zone file.');
            });
        }

        function fetchServerRole() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('server-role-status').textContent = data.server_role;
                    document.getElementById('server-role').value = data.server_role;
                })
                .catch(error => console.error('Error fetching server role:', error));
        }

        fetchZones();
        fetchServerRole();

        document.getElementById('server-role').addEventListener('change', function() {
            const masterConfig = document.getElementById('master-config');
            const slaveConfig = document.getElementById('slave-config');
            if (this.value === 'master') {
                masterConfig.style.display = 'block';
                slaveConfig.style.display = 'none';
            } else if (this.value === 'slave') {
                masterConfig.style.display = 'none';
                slaveConfig.style.display = 'block';
            } else {
                masterConfig.style.display = 'none';
                slaveConfig.style.display = 'none';
            }
        });

        document.getElementById('server-config-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    alert('Configuration saved successfully!');
                } else {
                    alert('Failed to save configuration.');
                }
            })
            .catch(error => {
                console.error('Error saving configuration:', error);
                alert('An error occurred while saving the configuration.');
            });
        });
    </script>
</body>
</html>
