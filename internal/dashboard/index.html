<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNS Resolver Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; color: #333; margin: 20px; }
        h1 { text-align: center; color: #0056b3; }
        .container { display: flex; flex-wrap: wrap; justify-content: space-around; }
        .metric-card { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 20px; margin: 10px; min-width: 200px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-card h2 { margin-top: 0; font-size: 1.2em; color: #0056b3; }
        .metric-card .value { font-size: 2em; font-weight: bold; color: #333; }
        .table-card { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 20px; margin: 10px; width: 45%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table-card h2 { margin-top: 0; font-size: 1.2em; color: #0056b3; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>DNS Resolver Dashboard</h1>
    <div class="container">
        <div class="metric-card">
            <h2>QPS</h2>
            <div id="qps" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Total Queries</h2>
            <div id="total-queries" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>CPU Usage</h2>
            <div id="cpu-usage" class="value">0%</div>
        </div>
        <div class="metric-card">
            <h2>Memory Usage</h2>
            <div id="memory-usage" class="value">0%</div>
        </div>
        <div class="metric-card">
            <h2>Goroutines</h2>
            <div id="goroutines" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Cache Hits</h2>
            <div id="cache-hits" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Cache Misses</h2>
            <div id="cache-misses" class="value">0</div>
        </div>
        <div class="metric-card">
            <h2>Cache Hit Rate</h2>
            <div id="cache-hit-rate" class="value">0%</div>
        </div>
    </div>
    <div class="container">
        <div class="table-card">
            <h2>Top NXDOMAINs</h2>
            <table id="top-nx-domains">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="table-card">
            <h2>Top Latency Domains (ms)</h2>
            <table id="top-latency-domains">
                <thead>
                    <tr>
                        <th>Domain</th>
                        <th>Avg Latency</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container">
        <div class="table-card" style="width: 90%;">
            <h2>Server Configuration</h2>
            <form id="server-config-form">
                <label for="server-role">Server Role:</label>
                <select id="server-role" name="server-role">
                    <option value="standalone">Standalone</option>
                    <option value="master">Master</option>
                    <option value="slave">Slave</option>
                </select>
                <div id="master-config" style="display: none;">
                    <h3>Master Configuration</h3>
                    <label for="slave-ips">Slave IPs:</label>
                    <input type="text" id="slave-ips" name="slave-ips" placeholder="e.g., 192.168.1.10, 192.168.1.11">
                </div>
                <div id="slave-config" style="display: none;">
                    <h3>Slave Configuration</h3>
                    <label for="master-ip">Master IP:</label>
                    <input type="text" id="master-ip" name="master-ip" placeholder="e.g., 192.168.1.1">
                </div>
                <button type="submit">Save Configuration</button>
            </form>
        </div>
    </div>
    <div class="container">
        <div class="table-card">
            <h2>Query Types</h2>
            <table id="query-types">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="table-card">
            <h2>Response Codes</h2>
            <table id="response-codes">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container">
        <div class="metric-card">
            <h2>Server Role</h2>
            <div id="server-role-status" class="value">Unknown</div>
        </div>
    </div>
    <div class="container" id="zone-management-container">
        <div class="table-card" style="width: 90%;">
            <h2>Zone Management</h2>
            <button onclick="showAddZoneModal()">Add Zone</button>
            <input type="file" id="zone-file-input" style="display: none;" onchange="importZoneFile()">
            <button onclick="document.getElementById('zone-file-input').click()">Import BIND9 Zone File</button>
            <table id="zones-table">
                <thead>
                    <tr>
                        <th>Zone Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="container" id="zone-records-container" style="display: none;">
        <div class="table-card" style="width: 90%;">
            <h2 id="zone-records-title"></h2>
            <button onclick="hideZoneRecords()">Back to Zones</button>
            <button onclick="showAddRecordModal()">Add Record</button>
            <table id="zone-records-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>TTL</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div id="record-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fff; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
            <h2 id="modal-title"></h2>
            <form id="record-form">
                <input type="hidden" id="record-id" name="record-id">
                <label for="record-name">Name:</label>
                <input type="text" id="record-name" name="record-name" required>
                <label for="record-type">Type:</label>
                <select id="record-type" name="record-type">
                    <option value="A">A</option>
                    <option value="AAAA">AAAA</option>
                    <option value="CNAME">CNAME</option>
                    <option value="MX">MX</option>
                    <option value="TXT">TXT</option>
                    <option value="NS">NS</option>
                    <option value="SOA">SOA</option>
                </select>
                <label for="record-ttl">TTL:</label>
                <input type="number" id="record-ttl" name="record-ttl" value="3600" required>
                <label for="record-value">Value:</label>
                <input type="text" id="record-value" name="record-value" required>
                <button type="submit">Save</button>
                <button type="button" onclick="hideRecordModal()">Cancel</button>
            </form>
        </div>
    </div>
    <div id="zone-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #fff; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
            <h2 id="zone-modal-title"></h2>
            <form id="zone-form">
                <input type="hidden" id="zone-id" name="zone-id">
                <label for="zone-name">Name:</label>
                <input type="text" id="zone-name" name="zone-name" required>
                <button type="submit">Save</button>
                <button type="button" onclick="hideZoneModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        function fetchMetrics() {
            fetch('/metrics.json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('qps').textContent = data.qps.toFixed(2);
                    document.getElementById('total-queries').textContent = data.total_queries;
                    document.getElementById('cpu-usage').textContent = data.cpu_usage.toFixed(2) + '%';
                    document.getElementById('memory-usage').textContent = data.memory_usage.toFixed(2) + '%';
                    document.getElementById('goroutines').textContent = data.goroutines;
                    document.getElementById('cache-hits').textContent = data.cache_hits;
                    document.getElementById('cache-misses').textContent = data.cache_misses;
                    document.getElementById('cache-hit-rate').textContent = data.cache_hit_rate.toFixed(2) + '%';

                    updateTable('top-nx-domains', data.top_nx_domains, ['domain', 'count']);
                    updateTable('top-latency-domains', data.top_latency_domains, ['domain', 'avg_latency']);
                    updateTable('query-types', data.query_types, ['type', 'count']);
                    updateTable('response-codes', data.response_codes, ['code', 'count']);
                })
                .catch(error => console.error('Error fetching metrics:', error));
        }

        function updateTable(tableId, data, columns) {
            const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear existing rows
            if (data) {
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    columns.forEach((col, index) => {
                        const cell = row.insertCell(index);
                        let value = item[col];
                        if (typeof value === 'number' && col === 'avg_latency') {
                            value = value.toFixed(4);
                        }
                        cell.textContent = value;
                    });
                });
            }
        }

        // Fetch metrics on page load and then every 2 seconds
        fetchMetrics();
        setInterval(fetchMetrics, 2000);

        function fetchZones() {
            fetch('/zones')
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched zones:', data);
                    const tableBody = document.getElementById('zones-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = ''; // Clear existing rows
                    if (data) {
                        data.forEach(zone => {
                            const row = tableBody.insertRow();
                            const nameCell = row.insertCell(0);
                            const actionsCell = row.insertCell(1);
                            nameCell.textContent = zone;
                            actionsCell.innerHTML = `
                                <button onclick="showZoneRecords('${zone}')">Manage</button>
                                <button onclick="showEditZoneModal('${zone}')">Edit</button>
                                <button onclick="deleteZone('${zone}')">Delete</button>
                                <button onclick="exportZone('${zone}')">Export</button>
                                <button onclick="notifyZone('${zone}')">Notify Slaves</button>
                            `;
                        });
                    }
                })
                .catch(error => console.error('Error fetching zones:', error));
        }

        function showAddZoneModal() {
            document.getElementById('zone-modal-title').textContent = 'Add Zone';
            document.getElementById('zone-form').reset();
            document.getElementById('zone-modal').style.display = 'block';
        }

        function showEditZoneModal(zoneName) {
            document.getElementById('zone-modal-title').textContent = 'Edit Zone';
            document.getElementById('zone-id').value = zoneName;
            document.getElementById('zone-name').value = zoneName;
            document.getElementById('zone-modal').style.display = 'block';
        }

        function hideZoneModal() {
            document.getElementById('zone-modal').style.display = 'none';
        }

        function deleteZone(zoneName) {
            if (confirm('Are you sure you want to delete this zone?')) {
                fetch(`/zones`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: zoneName }),
                })
                .then(response => {
                    if (response.ok) {
                        fetchZones();
                    } else {
                        alert('Failed to delete zone.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting zone:', error);
                    alert('An error occurred while deleting the zone.');
                });
            }
        }

        function exportZone(zoneName) {
            window.location.href = `/zones/export?zone=${zoneName}`;
        }

        function notifyZone(zoneName) {
            if (confirm(`Are you sure you want to send a NOTIFY for zone ${zoneName} to all slave servers?`)) {
                fetch(`/zones/${zoneName}/notify`, {
                    method: 'POST',
                })
                .then(response => {
                    if (response.ok) {
                        alert(`Successfully sent NOTIFY for zone ${zoneName}`);
                    } else {
                        response.text().then(text => alert(`Failed to send NOTIFY: ${text}`));
                    }
                })
                .catch(error => {
                    console.error('Error sending notify:', error);
                    alert('An error occurred while sending the NOTIFY.');
                });
            }
        }

        function showZoneRecords(zoneName) {
            document.getElementById('zone-management-container').style.display = 'none';
            document.getElementById('zone-records-container').style.display = 'flex';
            document.getElementById('zone-records-title').textContent = 'Managing Zone: ' + zoneName;
            fetchZoneRecords(zoneName);
        }

        function hideZoneRecords() {
            document.getElementById('zone-management-container').style.display = 'flex';
            document.getElementById('zone-records-container').style.display = 'none';
        }

        function fetchZoneRecords(zoneName) {
            fetch(`/zones/${zoneName}/records`)
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('zone-records-table').getElementsByTagName('tbody')[0];
                    tableBody.innerHTML = ''; // Clear existing rows
                    if (data) {
                        data.forEach(record => {
                            const row = tableBody.insertRow();
                            const nameCell = row.insertCell(0);
                            const typeCell = row.insertCell(1);
                            const ttlCell = row.insertCell(2);
                            const valueCell = row.insertCell(3);
                            const actionsCell = row.insertCell(4);

                            nameCell.textContent = record.name;
                            typeCell.textContent = record.type;
                            ttlCell.textContent = record.ttl;
                            valueCell.textContent = record.value;
                            actionsCell.innerHTML = `
                                <button onclick="showEditRecordModal('${zoneName}', '${record.id}')">Edit</button>
                                <button onclick="deleteRecord('${zoneName}', '${record.id}')">Delete</button>
                            `;
                        });
                    }
                })
                .catch(error => console.error('Error fetching zone records:', error));
        }

        function deleteRecord(zoneName, recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
                fetch(`/zones/${zoneName}/records/${recordId}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (response.ok) {
                        fetchZoneRecords(zoneName);
                    } else {
                        alert('Failed to delete record.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting record:', error);
                    alert('An error occurred while deleting the record.');
                });
            }
        }

        function showAddRecordModal() {
            document.getElementById('modal-title').textContent = 'Add Record';
            document.getElementById('record-form').reset();
            document.getElementById('record-modal').style.display = 'block';
        }

        function showEditRecordModal(zoneName, recordId) {
            fetch(`/zones/${zoneName}/records`)
                .then(response => response.json())
                .then(data => {
                    const record = data.find(r => r.id == recordId);
                    if (record) {
                        document.getElementById('modal-title').textContent = 'Edit Record';
                        document.getElementById('record-id').value = record.id;
                        document.getElementById('record-name').value = record.name;
                        document.getElementById('record-type').value = record.type;
                        document.getElementById('record-ttl').value = record.ttl;
                        document.getElementById('record-value').value = record.value;
                        document.getElementById('record-modal').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error fetching record:', error));
        }

        function hideRecordModal() {
            document.getElementById('record-modal').style.display = 'none';
        }

        function importZoneFile() {
            const fileInput = document.getElementById('zone-file-input');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a zone file to import.');
                return;
            }

            const formData = new FormData();
            formData.append('zonefile', file);

            fetch('/zones/import', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                if (response.ok) {
                    alert('Zone file imported successfully!');
                    fetchZones(); // Refresh the zones list
                } else {
                    alert('Failed to import zone file.');
                }
            })
            .catch(error => {
                console.error('Error importing zone file:', error);
                alert('An error occurred while importing the zone file.');
            });
        }

        function fetchServerRole() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('server-role-status').textContent = data.server_role;
                    document.getElementById('server-role').value = data.server_role;
                })
                .catch(error => console.error('Error fetching server role:', error));
        }

        fetchZones();
        fetchServerRole();

        document.getElementById('server-role').addEventListener('change', function() {
            const masterConfig = document.getElementById('master-config');
            const slaveConfig = document.getElementById('slave-config');
            if (this.value === 'master') {
                masterConfig.style.display = 'block';
                slaveConfig.style.display = 'none';
            } else if (this.value === 'slave') {
                masterConfig.style.display = 'none';
                slaveConfig.style.display = 'block';
            } else {
                masterConfig.style.display = 'none';
                slaveConfig.style.display = 'none';
            }
        });

        document.getElementById('record-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const recordId = formData.get('record-id');
            const zoneName = document.getElementById('zone-records-title').textContent.replace('Managing Zone: ', '');

            const data = {
                name: formData.get('record-name'),
                type: formData.get('record-type'),
                ttl: parseInt(formData.get('record-ttl')),
                value: formData.get('record-value'),
            };

            let url = `/zones/${zoneName}/records`;
            let method = 'POST';
            if (recordId) {
                url += `/${recordId}`;
                method = 'PUT';
            }

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    hideRecordModal();
                    fetchZoneRecords(zoneName);
                } else {
                    alert('Failed to save record.');
                }
            })
            .catch(error => {
                console.error('Error saving record:', error);
                alert('An error occurred while saving the record.');
            });
        });

        document.getElementById('server-config-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (response.ok) {
                    alert('Configuration saved successfully!');
                } else {
                    alert('Failed to save configuration.');
                }
            })
            .catch(error => {
                console.error('Error saving configuration:', error);
                alert('An error occurred while saving the configuration.');
            });
        });

        document.getElementById('zone-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const zoneId = formData.get('zone-id');
            const zoneName = formData.get('zone-name');

            let url = '/zones';
            let method = 'POST';
            let body = { name: zoneName };

            if (zoneId) {
                method = 'PUT';
                body = { oldName: zoneId, newName: zoneName };
            }

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            })
            .then(response => {
                if (response.ok) {
                    hideZoneModal();
                    fetchZones();
                } else {
                    alert('Failed to save zone.');
                }
            })
            .catch(error => {
                console.error('Error saving zone:', error);
                alert('An error occurred while saving the zone.');
            });
        });
    </script>
</body>
</html>
